> 翻译自：[http://jprante.github.io/lessons/2012/07/26/Mmap-with-Lucene.html](http://jprante.github.io/lessons/2012/07/26/Mmap-with-Lucene.html)

一篇关于在Lucene中使用内存映射文件的好文章中，Uwe Schindler讨论了[为什么将`directory`切换到`MMapDirectory`](http://blog.thetaphi.de/2012/07/use-lucenes-mmapdirectory-on-64bit.html)在目前看来是一件好事情。

在这篇文章中我自己产生了一些问题，也产生了一些思考，所以我决定写下更多关于虚拟内存方面的东西。

我产生的第一个问题是：为什么内存映射文件相比分页是更好的选择 — 因为它们都是受OS所管理，并且它们都尝试在内存与外部磁盘之间，优化内存资源的使用？

那么将Lucene索引中保留在内存中，`RAMDirectory`是一个好的选择吗？

或者：每个64位的系统都适合使用内存映射文件吗？

另一个问题是：Linux/Solaris提供了充足的方案将Lucene `directory`切换到`mmap`吗？

在开始寻找答案之前，让我们快速回顾一下类UNIX操作系统中的分页。

## Paging

分页发生在OS层面，OS管理进程指令，数据，以及各种类型的缓存，例如文件系统缓存，所以它们可以在虚拟内存地址空间中并存。因为OS知道整个系统的运行情况，所以它可以正确的处理优先级。内存页可以被移动到RAM中或者外部存储中。用户空间中的应用不会强制OS改变分页策略。已经分页的数据仅仅通过页地址就可以被定位到。当内存页被交换了，它们通常不能在进程间进行分享。

交换或者（分页）通常被认为是性能杀手，因为它会在交换设备或者磁盘上的文件导致高I/O活动。但是分页并不总是有害的，在许多情况是有益的。在这些情况下，分页工作起来就像魔法缓存一样，只将正确的内存数据在正确的时间传递到正确的位置。

但是页缓存并不是通用的缓存。它是一个管理分页的高优先级内核任务。并且它还依靠操作系统关于分页的处理。Solaris，Linux，Windows，Mac OS X有完全不同的分页行为。

为什么禁止分页会有效？有两种类型的应用会限制分页：高安全（在内存中保存类似密钥这种东西）以及为了提高低延迟的实时应用。类似Lucene这种搜索引擎就属于后者。

